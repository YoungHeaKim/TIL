2017/09/04

# 모던웹 서비스의 구성요소
- - -
# Express Middleware
## Middleware의 생김새
```js
// 미들웨어 = 함수
function helloMiddleware(res, req, next) {
  console.log('hello')
  next()
}

app.use(helloMiddleware)
```
미들웨어는 함수이다.  
응답객체, 요청객체, next객체를 인자로 받는다.  
요청이 일어났을때마다 콘솔을 찍는다.  

## Middleware란?
- 함수, 즉 안에서 어떤 작업이든 가능
- request 객체, response 객체, next 함수를 인자로 받음
- request 객체 response 객체를 조작해서 기능구현  
- 다음 미들웨어를 동작시키기 위해 next 함수를 인자 없이 호출
- 등록된 순서대로 실행됨(이것이 중요하다.)

## app.use
미들웨어를 앱 전체에서 동작하도록 주입할 때
```js
app.use(helloMiddleware)
```

특정 경로에서만 동작하도록 주입
```js
app.use('/some-path', helloMiddleware)
```

한 번에 여러 개 주입
```js
app.use(middleware1, middleware2, middleware3, ...)
```

## 미들웨어로 하는 일
- 로깅(morgan사용)
- http body를 객체로 변환(body-parser)
- 사용자 인증
- 권한 관리(각 컨텐츠의 소유지만 수정 삭제 권한을 주는 관리)

## 미들웨어를 사용하는 이유
미들웨어로 할 수 있는 모든 일은 라우트 핸들러에서도 할 수 있으나, 여러 라우터에서 사용해야 하는 기능을 중복 작성하는 불편을 덜고 코드를 재사용하기 위해 미들웨어를 사용하는 것

## 미들웨어 생태계
- Express resource
- NPM search
위의 두개를 NPM에서 검색해보면 거의 웬만한 기능들은 다 있다.  

## Express 미들웨어 예제
### next?
미들웨어는 req, res에 더해서 next라는 함수를 추가로 인자로 받습니다. next 함수를 호출하면 다음 미들웨어로 처리를 넘기는 효과가 있습니다. 만약에 미들웨어가 next 함수를 호출하지도 않고, 응답도 보내지 않으면 클라이언트는 응답을 받지 못하게 되므로 주의해야 한다.  

브라우저는 기본적으로 요청을 두번 난리는데 이때 한번은 favicon.ico라는 것을 보낸다.  
node.js에서 만들 때는 exports를 사용한다.  

미들웨어에서 next를 보내거나 응답을 보내주어야 브라우저에서 받을 수 있다.  
locals라는 객체는 render해주는 것과 같이 동작한다.  
값을 변하지 않게 할 때는 locals를 쓰고 다른경우에는 render를 사용하는 것이 좋다.  
```js
exports.resLocalMiddleware = (req, res, next) => {
  res.locals.myVar = 'FASTCAMPUS!'
  next()
}
```
## App Local, Response Local
app.locals와 res.locals는 특별한 객체를 담고 있습니다. 템플릿에서는 res.render를 통해 명시적으로 주입받지 않아도 저 두 객체의 속성에 바로 접근할 수 있습니다.  
템플릿을 가리지 않고 사용되는 정보들, 예를 들어 '현재 로그인 중인 사용자 정보' 같은 것을 res.render에 매번 인자로 넘기는 것은 귀찮을 뿐더러 빠뜨리기도 쉽습니다. 그런 정보들을 템플릿에서 쉽게 사용하기 위해, app.locals나 res.locals에 우리가 원하는 이름으로 속성을 주입할 수 있습니다.  
app.locals는 앱 단위로 공통적으로 쓰이는 정보를 담는 목적으로 사용됩니다. res.locals는 각 요청마다 달라지는 정보를 담는 목적으로 사용됩니다.  
app.local 객체를 조작하는 것은 매우 쉽습니다. res 객체는 매 요청마다 새로 생성되어 미들웨어 바깥에서 접근할 수 있는 방법이 없으므로, res.locals를 조작하려면 미들웨어를 사용해야 합니다.  

## 클로저 함수
클로저를 사용하여 함수를 리턴하여 값을 저장하는 것을 클로저함수라 한다.  

## arrow 함수
```js
makeAdder2 = x => y => x+y
```
에로우 함수를 두개를 동시에 사용해주는대 이때 `y => x+y`를 괄호를 사용하여 묶어놓은 것을 말한다.   
자바스크립트 currying이라는 것을 검색해보고 참고하면된다.  

## lock
lock는 다른 함수들과 같은 코드를 사용하는데 다른 점은 `key =>`이부분이 추가된 것이다.  
lock은 미들웨어가 아니라 미들웨어를 만들어주는 함수이다.  

## 미들웨어 vs 라우트 핸들러
- 라우트 핸들러도 미들웨어이다. 그치만 특별하게 취급대는 것을 라우트 핸들러라 한다.  

## 404 페이지를 만드는 법
```js
app.use ((req, res, next) => {
  res.render('404.ejs')
})
```
위의 코드를 사용하여 404페이지를 만들 수 있다.  

## 에러 처리 미들웨어
###오류 처리
다른 미들웨어 함수와 동일반 방법으로 오류 처리 미들웨어 함수를 정의할 수 있지만, 오류 처리 함수는 3개가 아닌 4개의 인수, 즉 (err, req, res, next)를 갖는다는 점이 다릅니다.  

에러처리는 웹서버에서 어떠한 에러가 났을 때 슬랙에 연동하여 에러를 바로 처리할 수 있도록 만들 수 있다.  
Bugsnag을 이용하여 에러가 난 횟수를 그래프로 표출하고 어떠한 에러가 났는지 로그기록을 볼 수 있다.(에러처리 미들웨어)  
에러처리 미들웨어는 서비스하는 미들웨어가 있기 떄문에 직접 만들 일은 거의 없다.  
에러처리 미들웨어는 Sentry와 Bugsnag 등이 있다.  
[에러처리 미들웨어](https://expressjs.com/ko/guide/error-handling.html)

# Cookie

